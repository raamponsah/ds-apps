{% extends 'base.html' %}
{% load static %}

{% block navbar %}
    {% include 'partials/navbar.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid py-5 px-lg-5">



<!-- Filter + Search Form -->
<form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
        <label for="regionSelect" class="form-label">Filter by Region</label>
        <select class="form-select" id="regionSelect" name="region">
            <option value="">All Regions</option>
            {% for reg in regions %}
                <option value="{{ reg }}" {% if selected_region == reg %}selected{% endif %}>{{ reg }}</option>
            {% endfor %}
        </select>
    </div>

   <div class="col-md-2">
        <label for="branchCodeSelect" class="form-label">Filter by Branch Code</label>
        <select class="form-select" id="branchCodeSelect" name="branchCode">
            <option value="">All Branch Codes</option>
            {% for reg in branch_codes %}
                <option value="{{ branch_code }}" {% if selected_branch_code == reg %}selected{% endif %}>{{ branch_code }}</option>
            {% endfor %}
        </select>
    </div>

   <div class="col-md-2">
        <label for="branchNameSelect" class="form-label">Filter by Branch Name</label>
        <select class="form-select" id="branchNameSelect" name="branchName">
            <option value="">All Branches Names</option>
            {% for branch_name in branch_names %}
                <option value="{{ reg }}" {% if selected_branch_name == reg %}selected{% endif %}>{{ branch_name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label for="genderSelect" class="form-label">Filter by Gender</label>
        <select class="form-select" id="genderSelect" name="gender">
            <option value="">All Gender</option>
            {% for gender in genders %}
                <option value="{{ gender }}" {% if selected_gender == gender %}selected{% endif %}>{{ gender }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <label for="searchInput" class="form-label">Search</label>
        <input type="text" id="searchInput" name="search" class="form-control" value="{{ search_query }}" placeholder="Search by occupation, etc.">
    </div>
    <div class="col-md-1 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
</form>


{#color checkboxes red, orange, two shades of orange and gray (as unrecoverable) #}






    <!-- Plotly Chart -->
    <div id="plot-div" class="mb-5" style="width: 100%; height: 420px;"></div>


<div class="d-flex justify-content-between mt-10">
        <h5 class="mb-4">Customers Churning</h5>
<form method="get" class="d-flex justify-content-end" id="churnFilterForm" style="margin-bottom: 1rem; display:flex; flex-wrap:wrap; align-items:center; justify-items: center;  gap: 1rem;">
  <div style="display: flex; gap: 10px; flex-wrap: wrap;">

    <label style="display: flex; align-items: center; background-color: #8B0000; padding: 6px 12px; border-radius: 4px; color: white;">
      <input type="checkbox" name="churn_range" value="very_high" {% if 'very_high' in selected_ranges %}checked{% endif %} style="margin-right: 6px;">
      Very High
    </label>

    <label style="display: flex; align-items: center; background-color: #FF4500; padding: 6px 12px; border-radius: 4px; color: white;">
      <input type="checkbox" name="churn_range" value="high" {% if 'high' in selected_ranges %}checked{% endif %} style="margin-right: 6px;">
      High
    </label>

    <label style="display: flex; align-items: center; background-color: #FFA500; padding: 6px 12px; border-radius: 4px; color: black;">
      <input type="checkbox" name="churn_range" value="medium" {% if 'medium' in selected_ranges %}checked{% endif %} style="margin-right: 6px;">
      Medium
    </label>

    <label style="display: flex; align-items: center; background-color: #FFD580; padding: 6px 12px; border-radius: 4px; color: black;">
      <input type="checkbox" name="churn_range" value="low" {% if 'low' in selected_ranges %}checked{% endif %} style="margin-right: 6px;">
      Low
    </label>

    <label style="display: flex; align-items: center; background-color: #D3D3D3; padding: 6px 12px; border-radius: 4px; color: black;">
      <input type="checkbox" name="churn_range" value="very_low" {% if 'very_low' in selected_ranges %}checked{% endif %} style="margin-right: 6px;">
      Very Low
    </label>

  </div>

  <button type="submit" style="">Filter</button>
</form>

</div>
    <!-- Responsive Table -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover align-middle text-nowrap">
            <thead class="table-dark text-center">
                <tr>
                    <th>Age</th><th>Gender</th><th>Region</th><th>Marital Status</th><th>Occupation</th>
                    <th>Education</th><th>Account Type</th><th>Account Age</th><th>Num Products</th>
                    <th>Avg Balance</th><th>Dormant</th><th>Mobile Banking</th><th>Mobile Logins</th><th>USSD Usage</th>
                    <th>Internet Banking</th><th>ATM Txns</th><th>Linkage Active</th><th>Deposits</th><th>Withdrawals</th>
                    <th>Transfers</th><th>Loan History</th><th>Complaints</th><th>Days Since Complaint</th>
                    <th>Satisfaction</th><th>Rel Manager</th><th>Sector</th><th>Monthly Fees</th><th>Churned</th>
                </tr>
            </thead>
            <tbody>
                {% for record in page_obj %}
                <tr class="text-center">
                    <td>{{ record.age }}</td>
                    <td>{{ record.gender }}</td>
                    <td>{{ record.region }}</td>
                    <td>{{ record.marital_status }}</td>
                    <td>{{ record.occupation }}</td>
                    <td>{{ record.education }}</td>

                    <td>{{ record.account_type }}</td>
                    <td>{{ record.account_age_months }}</td>
                    <td>{{ record.num_products }}</td>
                    <td>{{ record.avg_balance }}</td>
                    <td>{{ record.is_dormant }}</td>
                    <td>{{ record.mobile_banking_active }}</td>
                    <td>{{ record.monthly_mobile_logins }}</td>
                    <td>{{ record.ussd_usage }}</td>
                    <td>{{ record.internet_banking_active }}</td>
                    <td>{{ record.atm_txns_per_month }}</td>
                    <td>{{ record.account_linkage_active }}</td>
                    <td>{{ record.monthly_deposits }}</td>
                    <td>{{ record.monthly_withdrawals }}</td>
                    <td>{{ record.monthly_transfers }}</td>
                    <td>{{ record.loan_repayment_history }}</td>
                    <td>{{ record.complaints_count }}</td>
                    <td>{{ record.days_since_last_complaint }}</td>
                    <td>{{ record.satisfaction_rating }}</td>
                    <td>{{ record.has_rel_manager }}</td>
                    <td>{{ record.sector }}</td>
                    <td>{{ record.monthly_fees }}</td>
                    <td>{{ record.churned }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <nav aria-label="Page navigation">

        <ul class="pagination justify-content-center mt-4">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if selected_region %}&region={{ selected_region }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">First</a>

                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if selected_region %}&region={{ selected_region }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}>Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">First</span></li>
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if selected_region %}&region={{ selected_region }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if selected_region %}&region={{ selected_region }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Last</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
                <li class="page-item disabled"><span class="page-link">Last</span></li>
            {% endif %}
        </ul>
    </nav>

</div>

<!-- Plotly Script -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    const keys = JSON.parse('{{ keys|escapejs }}');
    const dataDict = JSON.parse('{{ data|escapejs }}');

    const xValues = keys;
    const yValues = keys.map(key => dataDict[key]);

    const trace = {
        x: xValues,
        y: yValues,
        type: 'bar',
        marker: {
            color: 'rgba(58,200,225,.8)'
        }
    };

    const layout = {
        title: 'Feature Distribution for Closed Accounts',
        xaxis: {
            tickangle: -45,
            automargin: true
        },
        yaxis: {
            title: 'Sample Value'
        },
        margin: {
            b: 150
        }
    };

    Plotly.newPlot('plot-div', [trace], layout);
</script>
{% endblock %}
